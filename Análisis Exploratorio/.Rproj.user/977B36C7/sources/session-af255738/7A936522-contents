---
title: "SaludMental"
author: "Castores Afanosos"
output:
  pdf_document:
    latex_engine: xelatex  # ¡La clave está aquí!
  html_document:
    theme: cerulean
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(readxl)
library(skimr)
library(ggplot2)

```

Este análisis tiene como objetivo principal proporcionar una visión estadística elemental y una evaluación de la calidad de los datos contenidos en el dataset de salud mental, abarcando la identificación de tipos de variables, la cuantificación de datos faltantes (nulos o desconocidos) y la detección preliminar de valores atípicos (outliers).

```{r warning=FALSE}
SaludMental <- read_excel("SaludMental.xls")
head(SaludMental)
```

# Análisis descriptivo


## Estructura y Tipos de Datos

En primer lugar, la estructura del conjunto de datos es revisada para verificar que se han inferido correctamente el tipo de cada variable.

-   **Variables categóricas**. Columnas como la *comunidad*, el *sexo*, *circunstancia de contacto* o *diagnóstico,* las cuales, transformaremos en factores más adelante.

-   **Variables numéricas.** Variables como *Estancia Días* o *Edad* fueron confirmadas como de tipo entero (`int`), double(`dbl`) o numérico (`num`), permitiendo el cálculo de medidas de tendencia central y dispersión.

-   **Tipos de Datos Desconocidos.** Se identificaron algunas variables como *CCAA Residencia* o *Reingreso* en las que no hay datos, por lo que no se tiene información de tipo, siendo interesante investrigar si se puede reconstruir o eliminarlas.

### Análisis Estadístico Elemental y Outliers

```{r}
summary(SaludMental)

```

Observamos que en algunas variables claves como la *Edad,* en la que la media y la mediana son muy cercanas, sugiriendo que sigue una distribución normal o muy ligeramente sesgada.

```{r}
summary(SaludMental$Edad)
```

```{r}
# 1. Calcular Media y Desviación Estándar (excluyendo NA)
media_edad <- mean(SaludMental$Edad, na.rm = TRUE)
sd_edad <- sd(SaludMental$Edad, na.rm = TRUE)
mediana_edad <- median(SaludMental$Edad, na.rm = TRUE)

# 2. Generar el gráfico con la curva de Densidad (naranja) Y la Gaussiana (roja)
SaludMental |>
  ggplot(aes(x = Edad)) +
  # 1. Histograma (Muestra la frecuencia real de los datos)
  geom_histogram(
    aes(y = after_stat(density)),
    binwidth = 5,
    fill = "#4C78A8",
    color = "white",
    alpha = 0.5
  ) +
  # 2. Curva de Densidad 

  # 3. Curva GAUSSIANA 
  geom_function(
    fun = dnorm, # La función de densidad normal
    args = list(mean = media_edad, sd = sd_edad),
    color = "#98FF98", # Color rojo/vino para diferenciar
    linewidth = 1.2
  ) +

  # 4. Marcas de Media y Mediana
  geom_vline(aes(xintercept = media_edad, color = "Media"),
             linetype = "dashed", linewidth = 1) +
  geom_vline(aes(xintercept = mediana_edad, color = "Mediana"),
             linetype = "solid", linewidth = 1) +

  # Etiquetas y tema
  scale_color_manual(name = "Estadístico",
                     values = c("Media" = "#4C78A8", "Mediana" = "#E45756")) +
  labs(
    title = "Distribución de la Edad vs. Curva Normal Teórica",
    subtitle = paste0("Media: ", round(media_edad, 2), " | Mediana: ", round(mediana_edad, 2), " | Desv. Estándar: ", round(sd_edad, 2)),
    x = "Edad (Años)",
    y = "Densidad"
  ) +
  theme_minimal()
```



Por otro lado, en variables como *Estancia Dias,* el valor máximo (814) está muy por encima de la media (15,46), lo que confirma la presencia de outliers extremos los cuales, elevan el valor de la media con relación a la mediana (11), dando lugar a una distribución sesgada.

```{r warning=FALSE}
summary(SaludMental$`Estancia Días`)
```

```{r warning=FALSE}
# 1. Calcular Media, Mediana de Estancia Días (excluyendo NA)
media_estancia <- mean(SaludMental$`Estancia Días`, na.rm = TRUE)
mediana_estancia <- median(SaludMental$`Estancia Días`, na.rm = TRUE)

# 2. Generar el gráfico de distribución
SaludMental |>
  ggplot(aes(x = `Estancia Días`)) +
  # 1. Histograma (Muestra la frecuencia real de los datos)
  geom_histogram(
    aes(y = after_stat(density)),
    binwidth = 5, # Agrupa los días en intervalos de 5
    fill = "#4C78A8",
    color = "white",
    alpha = 0.5
  ) +
  # 2. Curva de Densidad 
  geom_density(linewidth = 1.2, color = "#98FF98", adjust = 2) +

  # 4. Marcas de Media y Mediana
  geom_vline(aes(xintercept = media_estancia, color = "Media"),
             linetype = "dashed", linewidth = 1) +
  geom_vline(aes(xintercept = mediana_estancia, color = "Mediana"),
             linetype = "solid", linewidth = 1) +

  # Limitamos el eje X para apreciar la asimetría y evitar que el outlier de 814 comprima el gráfico
  xlim(0, 80) +

  scale_color_manual(name = "Estadístico",
                     values = c("Media" = "#4C78A8", "Mediana" = "#E45756")) +
  labs(
    title = "Distribución de la Estancia en Días",
    subtitle = paste0("Media: ", round(media_estancia, 2), " | Mediana: ", round(mediana_estancia, 2)),
    x = "Estancia Días",
    y = "Densidad"
  ) +
  theme_minimal()
```


De la misma forma, la variable *Peso Español APR* tiene un sutil sesgo negativo, ya que al igual que la variable anterior, contiene potenciales outliers.

```{r warning=FALSE}
# 1. Calcular Media, Mediana y Desviación Estándar de Estancia Días (excluyendo NA)
media_pesoEsp <- mean(SaludMental$`Peso Español APR`, na.rm = TRUE)
mediana_pesoEsp <- median(SaludMental$`Peso Español APR`, na.rm = TRUE)

# 2. Generar el gráfico de distribución
SaludMental |>
  ggplot(aes(x = `Peso Español APR`)) +
  # 1. Histograma (Muestra la frecuencia real de los datos)
  geom_histogram(
    aes(y = after_stat(density)),
    binwidth = 0.5, # Agrupa los días en intervalos de 5
    fill = "#4C78A8",
    color = "white",
    alpha = 0.5
  ) +
  
  # Etiquetas y tema
  scale_color_manual(name = "Estadístico",
                     values = c("Media" = "#4C78A8", "Mediana" = "#E45756")) +
  labs(
    title = "Distribución del Peso Español APR",
    subtitle = paste0("Media: ", round(media_pesoEsp, 2), " | Mediana: ", round(mediana_pesoEsp, 2)),
    x = "Estancia Días",
    y = "Densidad"
  ) +
  theme_minimal()
```

### Análisis de Variables Categóricas

Como se ha mencionado, en primer lugar transformaremos las variables principales a factor, re-etiquetando las que sea necesario de acuerdo con las especificaciones dadas.

```{r}
SaludMental <- SaludMental |>
  mutate(
    # **SEXO:** 1. Varón / 2. Mujer / 3. Indeterminado / 9. No especificado
    Sexo = factor(
      Sexo,
      levels = c(1, 2, 3, 9),
      labels = c("Varón", "Mujer", "Indeterminado", "No especificado")
    ),

    # **Tipo Alta:** 1. Domicilio / 2. Traslado Hospital / 3. Alta voluntaria / 4. Éxitus / 5. Traslado Sociosanitario / 9. Otros/Desconocido
    `Tipo Alta` = factor(
      `Tipo Alta`,
      levels = c(1, 2, 3, 4, 5, 9),
      labels = c("Domicilio", "Traslado Otro Hospital", "Alta Voluntaria", "Éxitus", "Traslado Sociosanitario", "Otros/Desconocido")
    ),

    # **Régimen de financiación:** 1 a 9 según diccionario
    `Régimen Financiación` = factor(
      `Régimen Financiación`,
      levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
      labels = c("Seguridad Social", "Corporaciones Locales/Cabildos", "Mutuas de Asistencia", "Accidentes de Trabajo", "Accidentes de Tráfico", "Privado", "Financiación Mixta", "Otros", "Desconocido")
    ),
    
    # **Circunstancia de Contacto (Asumiendo que es Tipo de Ingreso):** 1. Urgente / 2. Programado / 9. Otros/Desconocido
    `Circunstancia de Contacto` = factor(
      `Circunstancia de Contacto`,
      levels = c(1, 2, 9), # Asumiendo que 9 es el código de Otros/Desconocido si existe.
      labels = c("Urgente", "Programado", "Otros/Desconocido")
    )
  )


```

Una vez re-etiquetadas, se convierte a factor las que quedan.
```{r}
# 1. Definir una lista de las variables categóricas (¡Añade todas las que sean relevantes!)
variables_categoricas <- c("Comunidad Autónoma", "Categoría", "Servicio", "Nivel Severidad APR", "Riesgo Mortalidad APR", "Tipo GRD APR", "Mes de Ingreso")

SaludMental <- SaludMental |>
  mutate(
    across(
      .cols = all_of(variables_categoricas),
      .fns = as.factor
    )
  )
# 2. Aplicar la conversión a factor usando mutate(across())
SaludMental <- SaludMental |>
  mutate(
    # 'across' permite aplicar una función a múltiples columnas
    across(
      .cols = all_of(variables_categoricas), # Selecciona las columnas de la lista
      .fns = as.factor                       # La función a aplicar (convertir a factor)
    )
  )


str(SaludMental[variables_categoricas])
```

A continuación, se representarán algunas

```{r}

SaludMental |> 
   ggplot(aes(x = "", fill = factor(Sexo))) + 
  geom_bar(stat = "count", width = 1) + 
  coord_polar(theta = "y") + 
  labs(title = "Distribución de Sexo", x = NULL, y = NULL) +
  theme_void() +
  scale_fill_manual(values = c("#1F77B4", "#FFC0CB", "#98FF98")) 
```

```{r}
SaludMental |> 
   ggplot(aes(x = "", fill = factor(`Circunstancia de Contacto`))) + 
  geom_bar(stat = "count", width = 1) + 
  coord_polar(theta = "y") + 
  labs(title = " Distribución Circunstancia de Contacto", x = NULL, y = NULL) +
  theme_void() +
  scale_fill_manual(values = c("#E45756","#4CAF50")) 
```

## Estudio de Valores Desconocidos (NA)

En este estudio veremos el porcentaje de valores NA del dataset.

```{r}
skim(SaludMental)
```

Como se puede observar en el resumen acerca de los valores nulos, hay muchas columnas con columnas vacías. 
Para verlo con más facilidad, se hará el porcentake de valores nulos para cada columna.

```{r}

# Porcentaje de NA en cada columna 
porcentaje_na_columnas <- sapply(SaludMental, function(x) sum(is.na(x)) / length(x) * 100)
porcentaje_na_columnas

```

De esta manera podemos observar que hay varias columnas con un alto porcentaje de valores nulos, como pueden ser muchos de los diagnósticos, además de varias columnas con todos los valores nulos, como *CCAA Residencia* o un gran número de los procedimientos.

## Detección y Análisis de Outliers

Como se ha mencionado, existen variables con outliers potenciales. Para visualizarlos mejor, vamos a prepresentarlos con un diagrama de caja y bigotes.

```{r}

# Usando la librería ggplot2 que ya estás cargando
SaludMental |>
  ggplot(aes(y = `Estancia Días`, x = "")) +
  geom_boxplot(
    fill = "#A8C6E1",      # Color de relleno de la caja
    color = "#4C78A8",     # Color del borde
    outlier.color = "red", # Colorear los outliers en rojo
    outlier.shape = 1      # Dar una forma específica (círculo hueco)
  ) +
  labs(
    title = "Detección de Outliers en 'Estancia Días'",
    subtitle = "Los puntos rojos representan las estancias extremas (outliers)",
    y = "Estancia Días (en días)",
    x = ""
  ) +
  # Eliminar etiquetas redundantes del eje X
  theme_minimal() +
  theme(axis.text.x = element_blank())
```

Debido a que los outliers mencionados están muy alejados de la media no se aprecia bien el diagrama, por lo que se mostrará una sección de este.

```{r}
SaludMental |>
  ggplot(aes(y = `Estancia Días`, x = "")) +
  geom_boxplot(fill = "#A8C6E1", color = "#4C78A8") +
  
  # Añadimos un límite en el eje Y para hacer "zoom" en el cuerpo de la distribución
  # Por ejemplo, para ver hasta el percentil 95 (que suele estar alrededor de 40-50 días)
  ylim(0, 80) +
  
  labs(
    title = "Distribución de 'Estancia Días' (Zoom en Estancias Cortas)",
    subtitle = "Valores superiores a 80 días cortados del gráfico para apreciar la densidad central",
    y = "Estancia Días (en días)",
    x = ""
  ) +
  theme_minimal() +
  theme(axis.text.x = element_blank())
```

De la misma forma, se hará un diagrama que refleje outliers en una variable categórica.
```{r}
SaludMental |>
  # Usamos la variable Tipo Alta ya etiquetada como factor
  ggplot(aes(x = `Tipo Alta`)) +
  geom_bar(fill = "#1F77B4", color = "white") +
  # Añadimos las etiquetas de conteo encima de las barras
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.5, size = 3) +
  labs(
    title = "Frecuencia del Tipo de Alta",
    subtitle = "El '9: Otros/Desconocido' es un outlier categórico por su baja frecuencia",
    x = "Tipo de Alta",
    y = "Frecuencia (Nº de Registros)"
  ) +
  theme_minimal() +
  # Rotar texto del eje X para mejor lectura
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# Ingeniería de características

## Variables Temporales y Demográficas
En este apartado vamos a agrupar las muestras de variables tanto demográficas como temporales.

Empezaremos segmentando la variable *Edad* en 3 grupos: Menores de Edad, Adultos hasta 45, Adultos hasta 65 y Mayores
```{r}
SaludMental <-  SaludMental |> 
  mutate(Edad_Rango = case_when( SaludMental$Edad < 18 ~ "Menor (0-17)", SaludMental$Edad >= 18 & SaludMental$Edad < 45 ~ "Adulto (18-44)", SaludMental$Edad >= 45 & SaludMental$Edad < 65 ~ "Adulto (45-64)", TRUE ~ "Mayor (65+)" ))


SaludMental |> 
  select(Nombre, Edad, Edad_Rango)
```


Por otro lado, también puede ser interesante añadir el día de la semana con el propósito de evaluar si los  los ingresos varían según el día.
```{r}
SaludMental <- SaludMental |> 
  mutate(
      Dia_Semana_Ingreso = wday(`Fecha de Ingreso`, label = TRUE, abbr = FALSE),
      Dia_Semana_Ingreso = as.factor(Dia_Semana_Ingreso)
    ) 


SaludMental |> 
  select(Nombre, `Fecha de Ingreso`, Dia_Semana_Ingreso)
```


## Variables Clínicas y de Calidad
Estas variables se centran en la complejidad clínica y la calidad asistencial, utilizando la información de diagnósticos y procedimientos. En este caso, contaremos a cuántos procedimientos se ha sometido cada paciente, así como el número de diagnósticos. 

```{r}
SaludMental <- SaludMental |>
  
  rowwise() |> # Cambiar el modo de procesamiento a 'Fila por Fila'
  mutate(
    # Num_Diagnosticos: Cuenta valores NO nulos en las columnas que empiezan por "Diagnóstico"
    Num_Diagnosticos = sum(!is.na(c_across(starts_with("Diagnóstico")))),
    
    # Num_Procedimientos: Cuenta valores NO nulos en las columnas que empiezan por "Procedimiento"
    Num_Procedimientos = sum(!is.na(c_across(starts_with("Procedimiento"))))
  ) |>
  
  ungroup()



SaludMental |> 
  select(Nombre, Num_Diagnosticos, Num_Procedimientos)
```
